<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO çœ‹æ¿ç®¡ç†ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.10/htmx.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .add-todo-form {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr 150px auto;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .form-group textarea {
            padding: 2px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .kanban-column {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            min-height: 400px;
        }

        .column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .column-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .column-count {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .todo-item {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: grab;
            transition: all 0.3s ease;
            position: relative;
        }

        .todo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .todo-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            cursor: grabbing;
        }

        .todo-content {
            font-size: 1rem;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .todo-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #666;
        }

        .todo-user {
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: 500;
        }

        .todo-due {
            color: #e74c3c;
            font-weight: 500;
        }

        .todo-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .todo-item:hover .todo-actions {
            opacity: 1;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .drop-zone {
            min-height: 50px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .status-badge {
            position: absolute;
            top: -5px;
            left: -5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-0 { background: #95a5a6; }
        .status-1 { background: #3498db; }
        .status-2 { background: #27ae60; }
        .status-3 { background: #e67e22; }
	.footer {
           position: fixed;
           bottom: 0;
           width: 100%;
           background-color: #f8f9fa;
           text-align: center;
           padding: 10px 0;
           box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .footer p {
           margin: 0;
           font-size: 14px;
           color: #6c757d;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .add-todo-form {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .kanban-board {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            body {
                padding: 10px;
            }
        }

        @media (max-width: 480px) {
            .add-todo-form {
                padding: 15px;
            }
            
            .kanban-column {
                padding: 15px;
            }
            
            .todo-item {
                padding: 12px;
            }
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æ¨¡æ…‹æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }
    </style>
</head>
<body>
   <div class="container">
      <!-- æ¨™é¡Œ -->
      <div class="header">
          <h1>ğŸ¯ TODO çœ‹æ¿ç®¡ç†ç³»çµ±</h1>
      </div>
      <!-- æ–°å¢TODOè¡¨å–® -->
      <form class="add-todo-form">
         <div class="form-group">
            <label for="context">å¾…è¾¦äº‹é …</label>
	    <textarea type="text" id="context" name="context" required placeholder="è«‹è¼¸å…¥å¾…è¾¦äº‹é …å…§å®¹..."></textarea>
         </div>
         <div class="form-group">
            <label for="user">è² è²¬äºº</label>
            <input type="text" id="user" name="user" required placeholder="è«‹è¼¸å…¥è² è²¬äººå§“å...">
         </div>
         <div class="form-group">
            <label for="duetime">æˆªæ­¢æ™‚é–“</label>
            <input type="datetime-local" id="duetime" name="duetime" required>
         </div>
         <button type="submit" class="btn btn-primary">â• æ–°å¢å¾…è¾¦</button>
      </form>

      <!-- çœ‹æ¿å€åŸŸ -->
      <div id="kanban-board" class="kanban-board">
         <!-- æœªåˆ†é¡ -->
         <div class="kanban-column" data-status="0">
            <div class="column-header">
               <span class="column-title">ğŸ“‹ æœªåˆ†é¡</span>
               <span class="column-count">0</span>
            </div>
            <div class="todos-container" id="todos-0"><!-- TODOé …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ --></div>
            <div class="drop-zone" data-status="0">æ‹–æ‹‰TODOé …ç›®åˆ°é€™è£¡</div>
         </div>

         <!-- è™•ç†ä¸­ -->
         <div class="kanban-column" data-status="1">
            <div class="column-header">
               <span class="column-title">ğŸ”„ è™•ç†ä¸­</span>
               <span class="column-count">0</span>
            </div>
            <div class="todos-container" id="todos-1"><!-- TODOé …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ --></div>
            <div class="drop-zone" data-status="1">æ‹–æ‹‰TODOé …ç›®åˆ°é€™è£¡</div>
         </div>

            <!-- å®Œæˆ -->
            <div class="kanban-column" data-status="2">
                <div class="column-header">
                    <span class="column-title">âœ… å®Œæˆ</span>
                    <span class="column-count">0</span>
                </div>
                <div class="todos-container" id="todos-2">
                    <!-- TODOé …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                </div>
                <div class="drop-zone" data-status="2">
                    æ‹–æ‹‰TODOé …ç›®åˆ°é€™è£¡
                </div>
            </div>

            <!-- æ“±ç½® -->
            <div class="kanban-column" data-status="3">
                <div class="column-header">
                    <span class="column-title">â¸ï¸ æ“±ç½®</span>
                    <span class="column-count">0</span>
                </div>
                <div class="todos-container" id="todos-3">
                    <!-- TODOé …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                </div>
                <div class="drop-zone" data-status="3">
                    æ‹–æ‹‰TODOé …ç›®åˆ°é€™è£¡
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>ç·¨è¼¯å¾…è¾¦äº‹é …</h2>
            <form id="editForm">
                <div class="form-group">
                   <label for="editContext">å¾…è¾¦äº‹é …</label>
		   <textarea type="text" id="editContext" name="context" required></textarea>
                </div>
                <div class="form-group">
                   <label for="editUser">è² è²¬äºº</label>
                   <input type="text" id="editUser" name="user" required>
                </div>
                <div class="form-group">
                   <label for="editDuetime">æˆªæ­¢æ™‚é–“</label>
                   <input type="datetime-local" id="editDuetime" name="duetime">
                </div>
                <button type="submit" class="btn btn-primary">æ›´æ–°</button>
            </form>
        </div>
    </div>
    <!--
    <div class="footer">
        <p>è¯çµ¡è³‡è¨Š: justgps@gmail.com</p>
    </div>
    -->
<script>
   let draggedElement = null;
   let editingTodoId = null;

   // æ¸²æŸ“TODOé …ç›®
   function renderTodos(todos) {
      for(let i = 0; i < 4; i++) {  // æ¸…ç©ºæ‰€æœ‰å®¹å™¨
         const container = document.getElementById(`todos-${i}`);
         if(container) container.innerHTML = '';
      }
      // æŒ‰ç‹€æ…‹åˆ†çµ„ä¸¦æ¸²æŸ“
      const statusCounts = [0, 0, 0, 0];
      todos.forEach(todo => {
         const status = parseInt(todo.isFinish);
         statusCounts[status]++;
         const container = document.getElementById(`todos-${status}`);
         if(container) {
            const todoElement = createTodoElement(todo);
            container.appendChild(todoElement);
         }
      });
      // æ›´æ–°è¨ˆæ•¸
      statusCounts.forEach((count, index) => {
         const countElement = document.querySelector(`[data-status="${index}"] .column-count`);
         if(countElement) countElement.textContent = count;
      });
   }

   // è¼‰å…¥æ‰€æœ‰TODO
   function loadTodos() {
      fetch('/apigateway/todos').then(response => response.json()).then(todos => { renderTodos(todos); }).catch(error => {
         console.error('è¼‰å…¥TODOå¤±æ•—:', error);
      });
   }

   // å‰µå»ºTODOå…ƒç´ 
   function createTodoElement(todo) {
      const div = document.createElement('div');
      div.title = "ID:" + todo.id;
      div.className = 'todo-item';
      div.draggable = true;
      div.setAttribute('data-id', todo.id);
      div.setAttribute('data-status', todo.isFinish);
      let dueDate = "";
      if(todo.duetime != "") {
         const date = new Date(todo.duetime);
         // å–å¾—å„éƒ¨åˆ†è³‡æ–™ï¼Œè£œé›¶ç”¨ padStart
         const yyyy = date.getFullYear();
         const mm = String(date.getMonth() + 1).padStart(2, '0'); // æœˆä»½å¾0é–‹å§‹
         const dd = String(date.getDate()).padStart(2, '0');
         const hh = String(date.getUTCHours()).padStart(2, '0');
         const mi = String(date.getUTCMinutes()).padStart(2, '0');
         const ss = String(date.getUTCSeconds()).padStart(2, '0');
         dueDate = `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
      }
      const createDate = new Date(todo.createdate).toLocaleDateString('zh-TW');
      todo.context = formatText(todo.context);  // æ ¼å¼åŒ–å…§å®¹
      div.innerHTML = `
         <div class="status-badge status-${todo.isFinish}"></div>
         <div class="todo-actions">
            <button class="btn btn-sm btn-warning" onclick="editTodo(${todo.id})">ç·¨è¼¯</button>
            <button class="btn btn-sm btn-danger" onclick="deleteTodo(${todo.id})">åˆªé™¤</button>
         </div>
         <div class="todo-content">${todo.context}</div>
         <div class="todo-meta">
            <span class="todo-user">ğŸ‘¤ ${todo.user}</span>
            <span class="todo-due">â° ${dueDate}</span>
         </div>
         <div style="margin-top: 8px; font-size: 0.8rem; color: #999;">å»ºç«‹æ—¥æœŸ: ${createDate}</div>
      `;
      // æ·»åŠ æ‹–æ‹‰äº‹ä»¶
      div.addEventListener('dragstart', handleDragStart);
      div.addEventListener('dragend', handleDragEnd);
      return div;
   }

   // æ‹–æ‹‰é–‹å§‹
   function handleDragStart(e) {
      draggedElement = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.outerHTML);
   }

   // æ‹–æ‹‰çµæŸ
   function handleDragEnd(e) {
      this.classList.remove('dragging');
      draggedElement = null;
   }

   // è¨­ç½®æ”¾ç½®å€åŸŸäº‹ä»¶
   document.addEventListener('DOMContentLoaded', function() {
      const dropZones = document.querySelectorAll('.drop-zone, .todos-container');
      dropZones.forEach(zone => {
         zone.addEventListener('dragover', handleDragOver);
         zone.addEventListener('drop', handleDrop);
         zone.addEventListener('dragenter', handleDragEnter);
         zone.addEventListener('dragleave', handleDragLeave);
      });
   });

   function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
   }

   function handleDragEnter(e) {
      e.preventDefault();
      if(this.classList.contains('drop-zone')) {
         this.classList.add('drag-over');
      }
   }

   function handleDragLeave(e) {
      if(this.classList.contains('drop-zone')) {
         this.classList.remove('drag-over');
      }
   }

   function handleDrop(e) {  // 
      e.preventDefault();
            
      if(this.classList.contains('drop-zone')) {
         this.classList.remove('drag-over');
      }

      if(draggedElement) {
         const newStatus = this.getAttribute('data-status') || this.closest('.kanban-column').getAttribute('data-status');
         const todoId = draggedElement.getAttribute('data-id');
         const currentStatus = draggedElement.getAttribute('data-status');

         if(newStatus !== currentStatus) {
            updateTodoStatus(todoId, newStatus);
         }
      }
   }

        // æ›´æ–°TODOç‹€æ…‹
        function updateTodoStatus(todoId, newStatus) {
            fetch(`/apigateway/todo/${todoId}`)
                .then(response => response.json())
                .then(todo => {
                    todo.isFinish = parseInt(newStatus).toString();
                    return fetch(`/apigateway/todo/${todoId}`, {
                        method: "PUT",
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(todo)
                    });
                })
                .then(response => {
                    if(response.ok) {
                        loadTodos(); // é‡æ–°è¼‰å…¥æ‰€æœ‰TODO
                    } else {
                       console.log(response);
                        alert('æ›´æ–°ç‹€æ…‹å¤±æ•—');
                    }
                })
                .catch(error => {
                    console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—:', error);
                    alert('æ›´æ–°ç‹€æ…‹å¤±æ•—');
                });
        }

        // åˆªé™¤TODO
        function deleteTodo(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å¾…è¾¦äº‹é …å—ï¼Ÿ')) {
                fetch(`/apigateway/todo/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        loadTodos();
                    } else {
                        alert('åˆªé™¤å¤±æ•—');
                    }
                })
                .catch(error => {
                    console.error('åˆªé™¤å¤±æ•—:', error);
                    alert('åˆªé™¤å¤±æ•—');
                });
            }
        }

        // ç·¨è¼¯TODO
        function editTodo(id) {
           fetch(`/apigateway/todo/${id}`)
              .then(response => response.json())
              .then(todo => {
                 editingTodoId = id;
                 document.getElementById('editContext').value = todo.context;
                 document.getElementById('editUser').value = todo.user;
                 // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
                 const duetime = new Date(todo.duetime);
                 document.getElementById('editDuetime').value = duetime.toISOString().slice(0, 16);
                 document.getElementById('editModal').style.display = 'block';
              })
              .catch(error => {
                 console.error('è¼‰å…¥TODOè©³æƒ…å¤±æ•—:', error);
                 alert('è¼‰å…¥TODOè©³æƒ…å¤±æ•—');
              });
        }

        // æ¨¡æ…‹æ¡†äº‹ä»¶
        document.querySelector('.close').addEventListener('click', function() {
            document.getElementById('editModal').style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('editModal');
            if(event.target === modal) {
                modal.style.display = 'none';
            }
        });

        // æ–°å¢)ç·¨è¼¯è¡¨å–®æäº¤
        document.getElementById('editForm').addEventListener('submit', function(e) {
           e.preventDefault();
           const formData = new FormData(this);
           const todoData = {
              context: formData.get('context'),
              user: formData.get('user'),
              duetime: formData.get('duetime')
           };

           // å…ˆç²å–åŸå§‹TODOæ•¸æ“š
           fetch(`/apigateway/todo/${editingTodoId}`)
                .then(response => response.json())
                .then(originalTodo => {
                    // åˆä½µæ•¸æ“š
                    const updatedTodo = {
                        ...originalTodo,
                        ...todoData
                    };
                    return fetch(`/apigateway/todo/${editingTodoId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedTodo)
                    });
                })
                .then(response => {
                    if (response.ok) {
                        document.getElementById('editModal').style.display = 'none';
                        loadTodos();
                    } else {
                        alert('æ›´æ–°å¤±æ•—');
                    }
                })
                .catch(error => {
                    console.error('æ›´æ–°å¤±æ•—:', error);
                    alert('æ›´æ–°å¤±æ•—');
                });
        });

        // æ–°å¢TODOè¡¨å–®æäº¤
        document.querySelector('.add-todo-form').addEventListener('submit', function(e) {
           e.preventDefault();
           const formData = new FormData(this);
           const todoData = {
              context: formData.get('context'),
              user: formData.get('user'),
              duetime: formData.get('duetime'), // "2025-05-27T09:22:00+08:00"
              isFinish: "0" // æ–°å¢çš„TODOé è¨­ç‚ºæœªåˆ†é¡
           };
           fetch('/apigateway/todo', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify(todoData)
           })
           .then(response => {
              if(response.ok) {
                 this.reset(); // æ¸…ç©ºè¡¨å–®
                 loadTodos(); // é‡æ–°è¼‰å…¥TODOåˆ—è¡¨
              } else {
                 alert('æ–°å¢å¤±æ•—');
              }
           })
           .catch(error => {
              console.error('æ–°å¢å¤±æ•—:', error);
              alert('æ–°å¢å¤±æ•—');
           });
        });
      
      // æ ¼å¼åŒ–æ–‡æœ¬ï¼ˆMarkdown-likeï¼‰
      function formatText(text) {
         return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
                .replace(/^â€¢ (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
                .replace(/^#{1,3} (.+)$/gm, function(match, text) {
                    const level = match.indexOf(' ');
                    return `<h${level}>${text}</h${level}>`;
                })
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.+)$/gm, function(match) {
                    if (!match.startsWith('<') && match.trim()) {
                        return `<p>${match}</p>`;
                    }
                    return match;
                });
       }

       // HTML è½‰ç¾©
       function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
       }



      // åˆå§‹åŒ–è¼‰å…¥æ‰€æœ‰TODO
      document.addEventListener('DOMContentLoaded', function() {
         loadTodos();
      });

   </script>
</body>
</html>
